<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Monday Night Darts</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container" style="max-width: 500px; margin: 50px auto; padding: 20px;">
        <header style="text-align: center; margin-bottom: 40px;">
            <h1>üéØ Monday Night Darts</h1>
            <h2 style="color: #9ca3af; font-size: 20px; font-weight: normal;">Reset Your Password</h2>
        </header>

        <div style="background: #1e293b; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div id="resetForm">
                <p style="color: #9ca3af; margin-bottom: 20px; text-align: center;">Enter your new password below</p>
                
                <div style="margin-bottom: 15px;">
                    <input type="password" id="newPassword" class="edit-score-input" 
                           placeholder="New Password" 
                           style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #3d4558; background: #2d3548; color: #fff;">
                    <input type="password" id="confirmPassword" class="edit-score-input" 
                           placeholder="Confirm New Password" 
                           style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #3d4558; background: #2d3548; color: #fff;">
                </div>
                
                <button id="updatePasswordBtn" class="finish-btn" style="width: 100%; background: #16a34a; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px;">
                    Update Password
                </button>
                
                <div id="message" style="margin-top: 20px; text-align: center; font-size: 14px;"></div>
            </div>

            <div id="successMessage" style="display: none; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
                <h3 style="color: #10b981; margin-bottom: 10px;">Password Updated!</h3>
                <p style="color: #9ca3af; margin-bottom: 20px;">Your password has been successfully updated.</p>
                <a href="index.html" style="display: inline-block; background: #2563eb; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold;">
                    Go to Login
                </a>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        // Initialize Supabase
        initSupabase();

        async function handlePasswordReset() {
            console.log('üîç Full URL:', window.location.href);
            console.log('üîç Hash:', window.location.hash);

            const messageDiv = document.getElementById('message');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');

            // Check if we have auth tokens in URL
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');

            console.log('üîç Type:', type);
            console.log('üîç Access Token:', accessToken ? 'Present' : 'Missing');

            if (!accessToken || type !== 'recovery') {
                messageDiv.innerHTML = '‚ùå Invalid or expired password reset link.<br><a href="index.html" style="color: #2563eb;">Return to login</a>';
                messageDiv.style.color = '#ef4444';
                document.getElementById('resetForm').querySelector('div').style.display = 'none';
                document.querySelector('button').style.display = 'none';
                return;
            }

            // Focus on first input
            newPasswordInput.focus();

            // Handle update button click
            document.getElementById('updatePasswordBtn').addEventListener('click', async () => {
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();

                if (!newPassword || !confirmPassword) {
                    messageDiv.textContent = 'Please fill in both fields';
                    messageDiv.style.color = '#ef4444';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    messageDiv.textContent = 'Passwords do not match';
                    messageDiv.style.color = '#ef4444';
                    return;
                }

                if (newPassword.length < 6) {
                    messageDiv.textContent = 'Password must be at least 6 characters';
                    messageDiv.style.color = '#ef4444';
                    return;
                }

                messageDiv.textContent = 'Updating password...';
                messageDiv.style.color = '#9ca3af';

                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    messageDiv.textContent = error.message;
                    messageDiv.style.color = '#ef4444';
                } else {
                    // Show success message
                    document.getElementById('resetForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                }
            });

            // Allow Enter key to submit
            const handleEnter = (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('updatePasswordBtn').click();
                }
            };

            newPasswordInput.addEventListener('keydown', handleEnter);
            confirmPasswordInput.addEventListener('keydown', handleEnter);
        }

        // Run when page loads
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(handlePasswordReset, 100);
        });
    </script>
</body>
</html>
