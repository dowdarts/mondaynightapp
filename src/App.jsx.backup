import React, { useState, useEffect, useRef, useMemo } from 'react';
import { ArrowLeft, Check, Hash, Undo2, X, History, Calculator, User, User2, UserMinus, Edit, Save, Trash2, AlertTriangle, TrendingUp, Trophy, LogOut } from 'lucide-react';

const DartsApp = () => {
  // --- State Helpers ---
  const createInitialGames = () => [
    // Added isSatOut property
    { id: 1, scores: Array(7).fill(''), isComplete: false, totalScore: 0, totalDarts: 0, tons: 0, finish: '', avg: 0, isSatOut: false },
    { id: 2, scores: Array(7).fill(''), isComplete: false, totalScore: 0, totalDarts: 0, tons: 0, finish: '', avg: 0, isSatOut: false },
    { id: 3, scores: Array(7).fill(''), isComplete: false, totalScore: 0, totalDarts: 0, tons: 0, finish: '', avg: 0, isSatOut: false },
  ];

  // App State
  const [matchCount, setMatchCount] = useState(1);
  const [completedMatches, setCompletedMatches] = useState([]); // Array of completed match objects
  const [games, setGames] = useState(createInitialGames()); // For current match tracking
  const [activeTab, setActiveTab] = useState('current'); // 'current', 'history', or 'overall'
  
  // Input State
  const [currentInput, setCurrentInput] = useState('');
  const [activeGameIdx, setActiveGameIdx] = useState(0);
  const [activeColIdx, setActiveColIdx] = useState(0);
  const [showFinishModal, setShowFinishModal] = useState(false);
  const [showSitOutConfirmModal, setShowSitOutConfirmModal] = useState(false);
  const [showNightCompleteModal, setShowNightCompleteModal] = useState(false); // NEW STATE
  const [finishTarget, setFinishTarget] = useState(null);

  // Editing State
  const [editingMatchId, setEditingMatchId] = useState(null);
  const [editingGameData, setEditingGameData] = useState([]); // Temporary data for the match being edited
  const isEditing = editingMatchId !== null;

  // Constants
  const COL_HEADERS = [3, 6, 9, 12, 15, 18, 21];

  // --- Calculations (Pure Functions) ---

  const calculateGameStats = (gameIndex, currentGamesState) => {
    // This helper returns the updated games array, it doesn't set state directly
    const newGames = [...currentGamesState];
    const game = { ...newGames[gameIndex] };
    
    // Safety check: if sat out, do not calculate scores
    if (game.isSatOut) {
        newGames[gameIndex] = { ...game, totalScore: 0, totalDarts: 0, tons: 0, avg: 0 };
        return newGames;
    }

    // Filter out empty strings or '/' from score entries for calculation
    const validScores = game.scores.filter(s => typeof s === 'number');
    const totalScore = validScores.reduce((a, b) => a + b, 0);
    const tons = validScores.filter(s => s >= 95).length;
    
    // Total darts is 3 * (number of non-empty rounds before a finish)
    let filledRounds = validScores.length;
    
    // If the game is complete, calculate darts based on the position of '/' or the end of the array
    if (game.isComplete && game.finish !== 'S/O') {
      const finishIndex = game.scores.findIndex(s => s === '/');
      filledRounds = finishIndex !== -1 ? finishIndex : 7; // If no '/', all 7 rounds were thrown
    } else {
        filledRounds = validScores.length;
    }

    const calculatedDarts = filledRounds * 3;
    const avg = calculatedDarts > 0 ? (totalScore / calculatedDarts).toFixed(2) : '0.00';

    newGames[gameIndex] = {
      ...game,
      totalScore,
      tons,
      avg,
      totalDarts: calculatedDarts,
      isComplete: game.finish !== '' || filledRounds === 7, // Re-check completion status
    };
    
    return newGames;
  };

  // --- Grand Totals Helper (For Current/Editing Match) ---
  const getGrandTotals = (gamesList) => {
    // IMPORTANT: Filter out games that were sat out (isSatOut: true)
    const countableGames = gamesList.filter(g => !g.isSatOut); 
    
    const score = countableGames.reduce((acc, g) => acc + (g.totalScore || 0), 0);
    const darts = countableGames.reduce((acc, g) => acc + (g.totalDarts || 0), 0);
    const avg = darts > 0 ? (score / darts).toFixed(2) : "0.00";
    return { score, darts, avg };
  };

  const currentTotals = getGrandTotals(games);
  const editingTotals = getGrandTotals(editingGameData);

  // --- Overall Stats Calculator (For New Tab) ---
  const overallStats = useMemo(() => {
    let totalScore = 0;
    let totalDarts = 0;
    let totalTons = 0;
    let myFinishes = 0;
    let completedGamesCount = 0;

    completedMatches.forEach(match => {
        match.games.forEach(game => {
            // Only count games that were actually played
            if (!game.isSatOut) {
                totalScore += game.totalScore || 0;
                totalDarts += game.totalDarts || 0;
                totalTons += game.tons || 0;
                completedGamesCount += 1;
                if (game.finish === 'M') {
                    myFinishes += 1;
                }
            }
        });
    });

    // Calculate the overall 1-dart average
    const overallAvg = totalDarts > 0 ? (totalScore / totalDarts).toFixed(3) : '0.000';

    return { totalScore, totalDarts, totalTons, myFinishes, overallAvg, completedGamesCount };
  }, [completedMatches]);


  // --- Core Input/Mutators ---

  const handleNumPress = (num) => {
    const activeGames = isEditing ? editingGameData : games;
    // const setActiveGames = isEditing ? setEditingGameData : setGames;
    
    if (activeGameIdx > 2 || activeGames[activeGameIdx]?.isSatOut) return; 
    if (currentInput.length >= 3) return; 
    setCurrentInput(prev => prev + num);
  };

  const handleBackspace = () => {
    if (currentInput.length > 0) {
      setCurrentInput(prev => prev.slice(0, -1));
    }
  };

  const handleEnter = () => {
    const activeGames = isEditing ? editingGameData : games;
    const setActiveGames = isEditing ? setEditingGameData : setGames;
    
    if (activeGameIdx > 2 || activeGames[activeGameIdx]?.isSatOut || activeColIdx > 6) return;
    if (currentInput === '') return;

    const scoreVal = parseInt(currentInput, 10);
    if (scoreVal > 180) {
      console.error("Score cannot exceed 180");
      setCurrentInput('');
      return;
    }

    setActiveGames(prev => {
      let newGames = [...prev];
      const activeGame = { ...newGames[activeGameIdx] };
      activeGame.scores = [...activeGame.scores];
      activeGame.scores[activeColIdx] = scoreVal;
      newGames[activeGameIdx] = activeGame;
      
      // Calculate stats immediately
      const updatedGames = calculateGameStats(activeGameIdx, newGames);
      // For editing, ensure the finish status is cleared if we're adding scores
      if(isEditing) updatedGames[activeGameIdx].finish = '';
      return updatedGames;
    });

    setCurrentInput('');

    if (activeColIdx < 6) {
      setActiveColIdx(prev => prev + 1);
    }
  };

  const handleUndo = () => {
    const activeGames = isEditing ? editingGameData : games;
    const setActiveGames = isEditing ? setEditingGameData : setGames;

    if (currentInput.length > 0) {
      setCurrentInput('');
      return;
    }
    
    // Cannot undo if the game was sat out
    if (activeGames[activeGameIdx]?.isSatOut) return;

    setActiveGames(prev => {
      const newGames = [...prev];
      const game = { ...newGames[activeGameIdx] };
      game.scores = [...game.scores];
      
      let targetColIdx = activeColIdx;
      let scoreFound = false;

      // Find the last filled score column to undo
      for (let i = activeColIdx; i >= 0; i--) {
        if (typeof game.scores[i] === 'number' || game.scores[i] === '/') {
          targetColIdx = i;
          scoreFound = true;
          break;
        }
      }

      if (scoreFound) {
        // If the score was a finish '/', clear it and remove completion status
        if (game.scores[targetColIdx] === '/') {
          game.scores[targetColIdx] = '';
          game.isComplete = false;
          game.finish = '';
        } else {
          // Otherwise, clear the score
          game.scores[targetColIdx] = '';
        }

        newGames[activeGameIdx] = game;
        setActiveColIdx(targetColIdx);

        // Recalculate stats
        return calculateGameStats(activeGameIdx, newGames);
      }
      
      // Handle undoing across games only in non-editing mode (standard play)
      if (!isEditing && activeGameIdx > 0 && activeColIdx === 0 && games[activeGameIdx].scores.every(s => s === '')) {
         const prevGameIdx = activeGameIdx - 1;
         const prevGame = { ...newGames[prevGameIdx] };
         
         if (prevGame.isComplete && !prevGame.isSatOut) {
            prevGame.isComplete = false;
            prevGame.finish = '';
            
            const slashIdx = prevGame.scores.findIndex(s => s === '/');
            if (slashIdx !== -1) {
              prevGame.scores = [...prevGame.scores];
              prevGame.scores[slashIdx] = '';
              setActiveGameIdx(prevGameIdx);
              setActiveColIdx(slashIdx);
            }
            
            newGames[prevGameIdx] = prevGame;
            return calculateGameStats(prevGameIdx, newGames);
         }
      }

      return newGames; // No score to undo, return original state
    });
  };

  // --- Finish Handling ---

  const handleEndScoreClick = (gameIndex = activeGameIdx) => {
    const activeGames = isEditing ? editingGameData : games;
    if (gameIndex > 2 || activeGames[gameIndex]?.isSatOut) return;
    setFinishTarget({ gameIndex, isEditing });
    setShowFinishModal(true);
  };

  const handleFinishModalClose = () => {
    setShowFinishModal(false);
    setFinishTarget(null);
  };
  
  /**
   * Finalizes the game currently targeted by the modal (either current game or history edit).
   * @param {string} finishType - 'M' (My Finish), 'P' (Partner Finish), or '' (Game Lost/No Finish).
   */
  const finalizeGame = (finishType) => {
    const { gameIndex, isEditing: targetIsEditing } = finishTarget;
    
    if (targetIsEditing) {
      // Editing Mode Finish Logic
      setEditingGameData(prev => {
        let newGames = [...prev];
        const game = { ...newGames[gameIndex] };
        game.scores = [...game.scores];
        
        // Find the index of the first empty cell or the first non-score value after the last score
        let finishColIdx = game.scores.findIndex(s => s === '' || s === '/');
        if (finishColIdx === -1) finishColIdx = 7; // If full, assume finish on 7th round

        // Mark current round with a slash to show it ended prematurely, but only if it's not already complete
        if (finishColIdx < 7) {
            game.scores[finishColIdx] = '/';
        }
        
        game.isComplete = true;
        game.finish = finishType; // Set 'M', 'P', or ''
        
        newGames[gameIndex] = game;
        return calculateGameStats(gameIndex, newGames);
      });

      // After setting finish, close modal and refocus on the finished game's final score cell
      handleFinishModalClose();
      setActiveColIdx(gameIndex === activeGameIdx ? activeColIdx : 0);
      setActiveGameIdx(gameIndex);

    } else {
      // Standard Play Finish Logic
      if (gameIndex === 2) {
        // Logic for finishing a Match
        setGames(currentGames => {
          let finalGamesState = [...currentGames];
          const lastGame = { ...finalGamesState[2] };
          
          const validScores = lastGame.scores.filter(s => typeof s === 'number');
          const filledCount = validScores.length;
          if (activeColIdx <= 6) lastGame.scores[activeColIdx] = '/';
          
          lastGame.isComplete = true;
          lastGame.totalDarts = filledCount * 3;
          lastGame.finish = finishType; 
          lastGame.totalScore = validScores.reduce((a, b) => a + b, 0);
          lastGame.avg = lastGame.totalDarts > 0 ? (lastGame.totalScore / lastGame.totalDarts).toFixed(2) : 0;
          finalGamesState[2] = lastGame;

          // Archive
          setCompletedMatches(prevHistory => [
            ...prevHistory,
            { matchId: matchCount, games: finalGamesState, totals: getGrandTotals(finalGamesState) }
          ]);

          // Transition to next match
          setMatchCount(c => c + 1);
          setActiveGameIdx(0);
          setActiveColIdx(0);
          return createInitialGames();
        });
      } else {
        // Normal Game Transition (Game 1 -> 2, or 2 -> 3)
        setGames(prev => {
          let newGames = [...prev];
          const game = { ...newGames[gameIndex] };
          
          const validScores = game.scores.filter(s => typeof s === 'number');
          const filledCount = validScores.length;
          
          if (activeColIdx <= 6) game.scores[activeColIdx] = '/';
          
          game.isComplete = true;
          game.totalDarts = filledCount * 3;
          game.finish = finishType; 
          
          newGames[gameIndex] = game;
          const updatedGames = calculateGameStats(gameIndex, newGames);

          // Move to the next game
          setActiveGameIdx(prevIdx => prevIdx + 1);
          setActiveColIdx(0);
          return updatedGames;
        });
      }
      handleFinishModalClose();
      setCurrentInput('');
    }
  };

  /**
   * Handler to show the sit out confirmation modal.
   */
  const handleSitOut = () => {
    if (isEditing) return; // Only for current match
    setShowSitOutConfirmModal(true);
  }
  
  /**
   * Executes the sit out logic after user confirmation.
   */
  const confirmSitOut = () => {
    setShowSitOutConfirmModal(false);

    setGames(currentGames => {
      const satOutGames = currentGames.map(game => ({
        ...game,
        isSatOut: true,
        isComplete: true,
        scores: Array(7).fill(''),
        totalScore: 0,
        totalDarts: 0,
        tons: 0,
        avg: 0,
        finish: 'S/O'
      }));

      // Archive this finished match
      setCompletedMatches(prevHistory => [
        ...prevHistory,
        { matchId: matchCount, games: satOutGames, totals: getGrandTotals(satOutGames) }
      ]);

      // Transition to next match
      setMatchCount(c => c + 1);
      setActiveGameIdx(0);
      setActiveColIdx(0);
      return createInitialGames();
    });

    setCurrentInput('');
  };
  
  // --- Night Complete Logic ---
  
  const handleNightComplete = () => {
    // Only allow if not currently editing history
    if (!isEditing) {
        setShowNightCompleteModal(true);
    }
  };
  
  const confirmNightComplete = () => {
    // Reset state for a "fresh night"
    setMatchCount(1);
    setGames(createInitialGames());
    setActiveGameIdx(0);
    setActiveColIdx(0);
    setCurrentInput('');
    setActiveTab('current'); // Go back to current tab
    // Note: completedMatches remains intact to preserve history/overall stats
    
    // Close the modal
    setShowNightCompleteModal(false);
  };
  

  // --- History Editing Logic ---

  const startEditMatch = (match) => {
    // Set the match data to the temporary editing state
    setEditingMatchId(match.matchId);
    setEditingGameData(match.games);
    // Switch to the 'current' tab which will render the editing view
    setActiveTab('current'); 
    // Reset active position to Game 1, Round 1 for a fresh start to editing
    setActiveGameIdx(0);
    setActiveColIdx(0);
    setCurrentInput('');
  };

  const cancelEdit = () => {
    setEditingMatchId(null);
    setEditingGameData([]);
    // The 'games' state remains untouched (it holds the new match)
    // Switch back to history view if they were there
    setActiveTab('history'); 
    setActiveGameIdx(0);
    setActiveColIdx(0);
    setCurrentInput('');
  };

  const saveEditedMatch = () => {
    const updatedTotals = getGrandTotals(editingGameData);

    setCompletedMatches(prevHistory => 
      prevHistory.map(match => 
        match.matchId === editingMatchId 
          ? { ...match, games: editingGameData, totals: updatedTotals }
          : match
      )
    );

    setEditingMatchId(null);
    setEditingGameData([]);
    setActiveTab('history');
    setActiveGameIdx(0);
    setActiveColIdx(0);
    setCurrentInput('');
  };
  
  // --- Keyboard Listener ---
  useEffect(() => {
    const handleKeyDown = (e) => {
      const activeGames = isEditing ? editingGameData : games;
      // Ignore keypresses if modal is open or current game is finished/sat out
      if (showFinishModal || showSitOutConfirmModal || showNightCompleteModal || activeGameIdx > 2 || activeGames[activeGameIdx]?.isSatOut) return;
      
      if (e.key >= '0' && e.key <= '9') {
        handleNumPress(e.key);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        handleEnter();
      } else if (e.key === 'Backspace') {
        e.preventDefault(); 
        handleUndo();
      } else if (e.key === '/') {
         e.preventDefault(); 
         handleEndScoreClick();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentInput, activeGameIdx, activeColIdx, games, editingGameData, isEditing, showFinishModal, showSitOutConfirmModal, showNightCompleteModal]);


  // --- Render Components ---

  const handleScoreCellClick = (gIdx, cIdx) => {
    if (!isEditing) return;
    
    // Check if the cell is past the finished point, if so, don't allow edit
    const game = editingGameData[gIdx];
    const finishIndex = game.scores.findIndex(s => s === '/');
    if (finishIndex !== -1 && cIdx > finishIndex) return;

    // A click moves the active input
    setActiveGameIdx(gIdx);
    setActiveColIdx(cIdx);
    setCurrentInput('');
  }
  
  const handleFinishCellClick = (gIdx) => {
    if (!isEditing) return;
    handleEndScoreClick(gIdx);
  }

  const renderTable = (gamesData, isReadOnly = false) => {
    
    return (
      <div className="w-full bg-white text-slate-900 rounded-lg shadow-xl overflow-hidden mb-4 text-xs sm:text-sm border border-slate-200">
        <div className="overflow-x-auto">
          <table className="w-full min-w-[800px] border-collapse">
            <thead>
              <tr className="bg-slate-200">
                <th className="border p-2 w-12">Game</th>
                <th className="border p-2 text-center" colSpan={7}>Darts</th>
                <th className="border p-2 text-center bg-slate-300" colSpan={5}>Totals</th>
              </tr>
              <tr className="bg-slate-100 text-slate-600">
                <th className="border p-1"></th>
                {COL_HEADERS.map(h => <th key={h} className="border p-1 w-12 text-center">{h}</th>)}
                <th className="border p-1 w-14 bg-emerald-50">Score</th>
                <th className="border p-1 w-12 bg-emerald-50">Darts</th>
                <th className="border p-1 w-10 bg-emerald-50">Tons</th>
                <th className={`border p-1 w-12 bg-emerald-50 ${isEditing && !isReadOnly ? 'cursor-pointer hover:bg-emerald-200' : ''}`}>Finish</th>
                <th className="border p-1 w-14 bg-emerald-50">Avg</th>
              </tr>
            </thead>
            <tbody>
              {gamesData.map((game, gIdx) => {
                  const satOutRowClasses = game.isSatOut ? 'bg-amber-950/40 line-through italic text-slate-400' : '';

                  return (
                  <tr key={game.id} className={`${!isReadOnly && activeGameIdx === gIdx && !isEditing ? 'bg-blue-50' : 'bg-white'} ${isEditing && activeGameIdx === gIdx ? 'bg-amber-50' : ''} ${satOutRowClasses}`}>
                    <td className="border p-2 text-center font-bold bg-slate-100">{game.id}</td>
                    {game.scores.map((score, cIdx) => {
                      const isActive = !isReadOnly && activeGameIdx === gIdx && activeColIdx === cIdx && !game.isSatOut;
                      const isTon = typeof score === 'number' && score >= 95;
                      const isFinishSlash = score === '/';
                      
                      let cellClasses = `border p-2 text-center font-mono text-lg h-10 w-12 relative ${isEditing && !isReadOnly && !game.isSatOut ? 'cursor-pointer hover:bg-yellow-100' : ''}`;
                      if (isActive) {
                        cellClasses += ` bg-blue-200 ring-2 ring-inset ring-blue-500`;
                      } else if (isFinishSlash) {
                          cellClasses += ` bg-slate-200`;
                      }

                      return (
                        <td 
                          key={cIdx} 
                          className={cellClasses}
                          onClick={() => handleScoreCellClick(gIdx, cIdx)}
                        >
                          {isActive ? (
                            <span className="text-blue-800 font-bold">{currentInput}<span className="animate-pulse">|</span></span>
                          ) : game.isSatOut ? (
                              <span className="text-slate-500">S/O</span>
                          ) : (
                            isTon ? (
                              <div className="flex items-center justify-center w-full h-full">
                                <span className="inline-flex items-center justify-center w-9 h-9 rounded-full border-2 border-red-500 text-slate-900 font-bold">{score}</span>
                              </div>
                            ) : (
                              <span className={isFinishSlash ? 'text-slate-400 font-bold' : 'text-slate-800'}>{score}</span>
                            )
                          )}
                        </td>
                      );
                    })}
                    <td className="border p-2 text-center font-bold bg-emerald-50">{game.totalScore}</td>
                    <td className="border p-2 text-center text-slate-600 bg-emerald-50">{game.totalDarts || '-'}</td>
                    <td className="border p-2 text-center text-slate-600 bg-emerald-50">{game.tons}</td>
                    {/* Finish Column */}
                    <td 
                        className={`border p-2 text-center font-bold bg-emerald-50 ${isEditing && !isReadOnly ? 'cursor-pointer hover:bg-emerald-200' : ''}`}
                        onClick={() => handleFinishCellClick(gIdx)}
                    >
                      <div className="flex justify-center items-center h-full">
                        {game.finish === 'S/O' ? (
                          <UserMinus size={20} className="text-amber-600" title="Sat Out" />
                        ) : game.finish === 'M' ? (
                          <Check size={20} className="text-emerald-600" title="My Finish" />
                        ) : game.finish === 'P' ? (
                          <Check size={20} className="text-orange-500" title="Partner's Finish" />
                        ) : game.finish === '' && game.isComplete ? (
                          <X size={20} className="text-red-500" title="Game Lost" />
                        ) : ''}
                      </div>
                    </td>
                    <td className="border p-2 text-center text-slate-600 bg-emerald-50">{game.avg}</td>
                  </tr>
              );})}
            </tbody>
          </table>
        </div>
      </div>
    );
  };
  
  // --- Overall Stats Renderer ---
  const renderOverallStats = () => {
      const stats = overallStats;
      const statItems = [
          { label: "Total Score", value: stats.totalScore, color: "text-white", icon: Calculator },
          { label: "Total Darts Thrown", value: stats.totalDarts, color: "text-slate-300", icon: Hash },
          { label: "Total Tons (95+)", value: stats.totalTons, color: "text-red-400", icon: Trophy },
          { label: "My Finishes", value: stats.myFinishes, color: "text-emerald-400", icon: Check },
      ];

      return (
          <div className="w-full max-w-5xl animate-in fade-in slide-in-from-bottom-4 duration-500 pb-10">
              <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-2xl mb-8">
                  <div className="flex items-center gap-3 mb-4 border-b border-slate-700 pb-3">
                      <TrendingUp size={28} className="text-yellow-400" />
                      <h2 className="text-2xl font-bold text-yellow-300">Overall 1-Dart Average</h2>
                  </div>
                  <div className="flex justify-between items-end">
                      <div className="text-slate-400 font-semibold">Across {stats.completedGamesCount} games played</div>
                      <span className="text-6xl font-extrabold text-yellow-400 font-mono tracking-tighter">
                          {stats.overallAvg}
                      </span>
                  </div>
              </div>

              <h3 className="text-xl font-bold text-slate-200 mb-4">Cumulative Match Totals</h3>

              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {statItems.map((item, index) => (
                      <div key={index} className="bg-slate-800 p-4 rounded-lg border-t-4 border-slate-600 shadow-lg flex flex-col justify-between h-full">
                          <div className="flex justify-between items-center mb-2">
                              <span className="text-sm text-slate-400 uppercase font-semibold tracking-wider">{item.label}</span>
                              <item.icon size={20} className={item.color} />
                          </div>
                          <span className={`text-4xl font-extrabold ${item.color} font-mono`}>
                              {item.value}
                          </span>
                      </div>
                  ))}
              </div>
              
              {stats.completedGamesCount === 0 && (
                  <div className="text-center text-slate-500 py-12 mt-8 bg-slate-800 rounded-lg border border-slate-700">
                      <p className="text-lg">Start completing matches to see your overall stats here!</p>
                  </div>
              )}
          </div>
      )
  }

  return (
    <div className="min-h-screen bg-slate-900 text-white font-sans flex flex-col items-center p-2 sm:p-4">
      
      {/* Header */}
      <div className="w-full max-w-5xl mb-6">
        <div className="flex justify-between items-center mb-4">
          <h1 className="text-xl sm:text-2xl font-bold text-emerald-400 flex items-center gap-2">
            <Hash /> Monday Night Average App
          </h1>
          <div className="bg-slate-800 px-4 py-1 rounded-full border border-slate-700 text-sm font-mono text-emerald-400">
            {isEditing ? (
              <span className="text-amber-300">Editing Match {editingMatchId}</span>
            ) : (
              <span>Current: Match {matchCount}</span>
            )}
          </div>
        </div>

        {/* Tabs */}
        <div className="flex gap-1 sm:gap-2 border-b border-slate-700">
          <button 
            onClick={() => setActiveTab('current')}
            className={`px-3 sm:px-4 py-2 rounded-t-lg flex items-center gap-2 transition text-sm sm:text-base ${activeTab === 'current' ? 'bg-emerald-600 text-white font-bold' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
          >
            <Calculator size={16} /> {isEditing ? `Edit Match ${editingMatchId}` : 'Current'}
          </button>
          <button 
            onClick={() => setActiveTab('history')}
            className={`px-3 sm:px-4 py-2 rounded-t-lg flex items-center gap-2 transition text-sm sm:text-base ${activeTab === 'history' ? 'bg-blue-600 text-white font-bold' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
          >
            <History size={16} /> History ({completedMatches.length})
          </button>
          <button 
            onClick={() => setActiveTab('overall')}
            className={`px-3 sm:px-4 py-2 rounded-t-lg flex items-center gap-2 transition text-sm sm:text-base ${activeTab === 'overall' ? 'bg-yellow-600 text-white font-bold' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
          >
            <Trophy size={16} /> Overall Stats
          </button>
        </div>
      </div>

      {/* --- Tab Content: Current Match / Editing View --- */}
      {activeTab === 'current' && (
        <>
          <div className="w-full max-w-5xl">
            {renderTable(isEditing ? editingGameData : games, false)}
          </div>

          <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Grand Totals Card */}
            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex flex-col justify-center">
              <h3 className="text-slate-400 uppercase text-xs font-bold mb-3 tracking-wider border-b border-slate-700 pb-2">
                {isEditing ? `Match ${editingMatchId} Totals (Recalculated)` : `Match ${matchCount} Totals`}
              </h3>
              <div className="grid grid-cols-1 gap-3">
                <div className="flex justify-between items-center">
                  <span className="text-slate-300">Total Score:</span>
                  <span className="text-2xl font-bold text-white">{isEditing ? editingTotals.score : currentTotals.score}</span>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-slate-300">Total Darts:</span>
                  <span className="text-2xl font-bold text-white">{isEditing ? editingTotals.darts : currentTotals.darts}</span>
                </div>
                <div className="flex justify-between items-center bg-emerald-900/30 p-2 rounded -mx-2">
                  <span className="text-emerald-400 font-bold">1 Dart Avg:</span>
                  <span className="text-3xl font-bold text-emerald-400">{isEditing ? editingTotals.avg : currentTotals.avg}</span>
                </div>
              </div>
            </div>

            {/* Keypad & Actions */}
            <div className="flex flex-col gap-2">
              
              {isEditing ? (
                // --- Editing Actions ---
                <div className="grid grid-cols-2 gap-2">
                  <button 
                      onClick={saveEditedMatch}
                      className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-sm flex items-center justify-center gap-1 active:scale-95 transition"
                  >
                      <Save size={18} /> Save Changes
                  </button>
                  <button 
                      onClick={cancelEdit}
                      className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-sm flex items-center justify-center gap-1 active:scale-95 transition"
                  >
                      <Trash2 size={18} /> Cancel Edit
                  </button>
                </div>
              ) : (
                // --- Standard Play Actions ---
                <div className="grid grid-cols-3 gap-2">
                  <button 
                      onClick={handleSitOut} // Triggers the confirmation modal
                      disabled={activeGameIdx > 2 || games[activeGameIdx]?.isSatOut}
                      className="bg-amber-600 hover:bg-amber-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-xs sm:text-sm flex items-center justify-center gap-1 active:scale-95 transition"
                  >
                      <UserMinus size={18} /> Sit Out
                  </button>
                  {/* NEW Position: # End Score Button */}
                  <button 
                      onClick={() => handleEndScoreClick()}
                      disabled={activeGameIdx > 2 || games[activeGameIdx]?.isSatOut}
                      className="bg-red-600 hover:bg-red-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-xs sm:text-sm truncate flex items-center justify-center gap-1 active:scale-95 transition"
                  >
                      <Hash size={18} /> End Score
                  </button>
                  {/* Night Complete Button */}
                  <button 
                      onClick={handleNightComplete}
                      disabled={isEditing}
                      className="bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-xs sm:text-sm truncate flex items-center justify-center gap-1 active:scale-95 transition"
                  >
                      <LogOut size={18} /> Night Done
                  </button>
                </div>
              )}


              {/* Row 2: Input Actions (Shared) */}
              <div className="grid grid-cols-2 gap-2">
                <button 
                  onClick={handleUndo}
                  className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-sm flex items-center justify-center gap-1 active:scale-95 transition"
                >
                  <Undo2 size={18} /> Undo
                </button>
                {/* OLD POSITION: End Score Button was here. Now Enter is here. */}
                <button 
                  onClick={() => handleEndScoreClick()}
                  disabled={activeGameIdx > 2 || (isEditing ? editingGameData[activeGameIdx]?.isSatOut : games[activeGameIdx]?.isSatOut)}
                  className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 rounded shadow-md uppercase tracking-wider text-sm truncate flex items-center justify-center gap-1 active:scale-95 transition"
                >
                    <Hash size={18} /> End Score
                </button>
              </div>

              <div className="grid grid-cols-3 gap-2 h-48">
                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                  <button 
                    key={num} 
                    onClick={() => handleNumPress(num.toString())} 
                    disabled={activeGameIdx > 2 || (isEditing ? editingGameData[activeGameIdx]?.isSatOut : games[activeGameIdx]?.isSatOut)}
                    className="bg-slate-700 hover:bg-slate-600 text-2xl font-bold rounded shadow active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {num}
                  </button>
                ))}
                <button onClick={handleBackspace} className="bg-slate-700 hover:bg-slate-600 text-xl font-bold rounded shadow flex items-center justify-center active:scale-95 transition text-red-300"><ArrowLeft /></button>
                <button 
                  onClick={() => handleNumPress('0')} 
                  className="bg-slate-700 hover:bg-slate-600 text-2xl font-bold rounded shadow active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed" 
                  disabled={activeGameIdx > 2 || (isEditing ? editingGameData[activeGameIdx]?.isSatOut : games[activeGameIdx]?.isSatOut)}
                >0</button>
                {/* NEW POSITION: Enter Button is here. */}
                <button 
                    onClick={handleEnter}
                    disabled={activeGameIdx > 2 || (isEditing ? editingGameData[activeGameIdx]?.isSatOut : games[activeGameIdx]?.isSatOut)}
                    className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold text-xl rounded shadow active:scale-95 transition"
                >
                  Enter
                </button>
              </div>
            </div>
          </div>
        </>
      )}

      {/* --- Tab Content: History --- */}
      {activeTab === 'history' && (
        <div className="w-full max-w-5xl flex flex-col gap-8 pb-10">
          {completedMatches.length === 0 ? (
            <div className="text-center text-slate-500 py-12 bg-slate-800 rounded-lg border border-slate-700">
              <History size={48} className="mx-auto mb-4 opacity-50" />
              <p className="text-lg">No matches completed yet.</p>
              <p className="text-sm">Finish Game 3 of the current match to see it here.</p>
            </div>
          ) : (
            completedMatches.map((match) => (
              <div key={match.matchId} className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="flex justify-between items-center mb-2 px-1">
                  <h2 className="text-lg font-bold text-blue-400 flex items-center gap-2">
                    <Check className="text-blue-500" size={18} />
                    Match #{match.matchId} Summary
                  </h2>
                  <button 
                    onClick={() => startEditMatch(match)} 
                    className="bg-slate-700 hover:bg-slate-600 text-xs text-white px-3 py-1 rounded-full flex items-center gap-1 transition active:scale-95"
                  >
                    <Edit size={14} /> Edit Scores
                  </button>
                </div>
                
                {renderTable(match.games, true)}
                
                <div className="grid grid-cols-3 gap-4 text-center bg-slate-800 p-3 rounded border border-slate-700 text-sm">
                  <div>
                    <span className="block text-slate-400 text-xs uppercase">Total Score (Played)</span>
                    <span className="text-xl font-bold text-white">{match.totals.score}</span>
                  </div>
                  <div>
                    <span className="block text-slate-400 text-xs uppercase">Total Darts (Played)</span>
                    <span className="text-xl font-bold text-white">{match.totals.darts}</span>
                  </div>
                  <div>
                    <span className="block text-emerald-400 text-xs uppercase">1 Dart Avg (Played)</span>
                    <span className="text-xl font-bold text-emerald-400">{match.totals.avg}</span>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      )}
      
      {/* --- Tab Content: Overall Stats --- */}
      {activeTab === 'overall' && renderOverallStats()}

      {/* Finish Confirmation Modal */}
      {showFinishModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-slate-800 p-6 rounded-xl max-w-lg w-full border border-slate-600 shadow-2xl animate-in fade-in zoom-in duration-200">
            <h3 className="text-xl font-bold text-white mb-4 text-center">Set Game Finish Type</h3>
            <p className="text-slate-300 mb-6 text-center text-sm">
              Please select the outcome for Game #{finishTarget.gameIndex + 1}.
            </p>
            
            <div className="grid grid-cols-3 gap-4">
               {/* Game Lost (No Finish) - RED */}
               <button onClick={() => finalizeGame('')} className="bg-red-600 hover:bg-red-500 py-4 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex flex-col items-center gap-1">
                  <X size={24} />
                  <span>Game Lost</span>
                </button>
                
                {/* Partner Finish - ORANGE */}
                <button onClick={() => finalizeGame('P')} className="bg-orange-500 hover:bg-orange-400 py-4 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex flex-col items-center gap-1">
                  <User size={24} />
                  <span>Partner Finish</span>
                </button>

                {/* My Finish - GREEN */}
                <button onClick={() => finalizeGame('M')} className="bg-emerald-600 hover:bg-emerald-500 py-4 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex flex-col items-center gap-1">
                  <User2 size={24} />
                  <span>My Finish</span>
                </button>
            </div>
            
            {/* Conditional messaging */}
            {finishTarget.isEditing ? (
                <p className="mt-4 text-center text-xs text-amber-300">
                    Your changes will be saved when you click the 'Save Changes' button on the main screen.
                </p>
            ) : (activeGameIdx === 2 && (
              <p className="mt-4 text-center text-xs text-blue-300 animate-pulse">
                Completing this game will finish Match #{matchCount} and start Match #{matchCount + 1}.
              </p>
            ))}
            
            <button 
              onClick={handleFinishModalClose} 
              className="mt-4 text-center w-full text-sm text-slate-400 hover:text-white transition"
            >
              Close
            </button>
          </div>
        </div>
      )}
      
      {/* Sit Out Confirmation Modal */}
      {showSitOutConfirmModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-slate-800 p-6 rounded-xl max-w-lg w-full border border-slate-600 shadow-2xl animate-in fade-in zoom-in duration-200">
            <div className="flex items-center gap-3 mb-4">
              <AlertTriangle size={32} className="text-red-500 flex-shrink-0" />
              <h3 className="text-2xl font-bold text-white">Confirm Sit Out</h3>
            </div>
            
            <p className="text-slate-300 mb-6">
              Are you sure you want to mark Match **{matchCount}** as **Sat Out**? 
              <br/>
              This action cannot be undone and the match will be permanently archived with all three games marked as 'S/O'.
            </p>
            
            <div className="grid grid-cols-2 gap-4">
               {/* Cancel */}
               <button 
                 onClick={() => setShowSitOutConfirmModal(false)} 
                 className="bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex items-center justify-center gap-1"
               >
                  Cancel
                </button>
                
                {/* Confirm */}
                <button 
                  onClick={confirmSitOut} 
                  className="bg-amber-600 hover:bg-amber-500 py-3 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex items-center justify-center gap-1"
                >
                  <Check size={20} /> Yes, I Sat Out
                </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Night Complete Confirmation Modal (NEW) */}
      {showNightCompleteModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="bg-slate-800 p-6 rounded-xl max-w-lg w-full border border-slate-600 shadow-2xl animate-in fade-in zoom-in duration-200">
            <div className="flex items-center gap-3 mb-4">
              <LogOut size={32} className="text-purple-400 flex-shrink-0" />
              <h3 className="text-2xl font-bold text-white">End Night Confirmation</h3>
            </div>
            
            <p className="text-slate-300 mb-6">
              Are you sure you want to **Complete the Night**? 
              <br/><br/>
              This will **erase the current match data** and reset the counter to Match #1 for a fresh start, but your **History and Overall Stats will be preserved**.
            </p>
            
            <div className="grid grid-cols-2 gap-4">
               {/* Cancel */}
               <button 
                 onClick={() => setShowNightCompleteModal(false)} 
                 className="bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex items-center justify-center gap-1"
               >
                  Cancel
                </button>
                
                {/* Confirm */}
                <button 
                  onClick={confirmNightComplete} 
                  className="bg-purple-600 hover:bg-purple-500 py-3 rounded-lg font-bold text-white shadow-lg active:scale-95 transition flex items-center justify-center gap-1"
                >
                  <Check size={20} /> Yes, Start Fresh Night
                </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default DartsApp;